name: Docker Publish

on:
  release:
    type: [published]

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:

    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.13

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Get dependencies
      env:
        GT: ${{ secrets.GT }}
      run: |
        git config --global url."https://${{ secrets.GT }}:x-oauth-basic@github.com/iantal".insteadOf "https://github.com/iantal"
        go mod tidy
        go get -v -t -d ./...
        if [ -f Gopkg.toml ]; then
            curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
            dep ensure
        fi

    - name: Build
      run: |
        go build -o main
    - uses: mr-smithers-excellent/docker-build-push@v4
      name: Build & push Docker image
      with:
        image: micky0000/seclens
        registry: docker.io
        dockerfile: docker/DockerfileGithubActions
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASS }}
